<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="utf-8" />
        <title>Temp</title>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <link rel="manifest" href="manifest.json" />
        <link rel="icon" type="image/png" href="favicon.png" />
        <meta name="viewport" content="width=device-width" />
        <script src="lib/chart.js" type="text/javascript"></script>
        <script src="lib/chartjs-adapter-date-fns.bundle.min.js" type="text/javascript"></script>
        <script src="app.js" type="text/javascript"></script>
        <script src="gsms.js" type="text/javascript"></script>
        <script type="text/javascript">
            const PRECISION = 1000
            let gm = new GameManager('prova')
            let stock2, stock3, etf
            gm.initializeSave(1)
            function chartTest_update(id) {
                document.getElementById('gameT').innerText = GameManager.gameTimerAsDate().toGMTString()
                let stock
                if(id == '1'){
                    masterStock._baseValue = Number(document.getElementById('baseValue'+id).value)
                    masterStock.influencability = Number(document.getElementById('influencability'+id).value)
                    masterStock.stability = Number(document.getElementById('stability'+id).value)
                    masterStock.growth = Number(document.getElementById('grow'+id).value)
                    masterStock.volatility = Number(document.getElementById('volatility'+id).value)
                    masterStock.seed = Number(document.getElementById('seed'+id).value)
                    stock = masterStock
                }
                else if(id == '2'){
                    stock = stock2 = new Stock("TEST"+id, 'CSA', "Test"+id, Number(document.getElementById('baseValue'+id).value), Number(document.getElementById('stability'+id).value), Number(document.getElementById('grow'+id).value), Number(document.getElementById('volatility'+id).value), Number(document.getElementById('seed'+id).value), Number(document.getElementById('influencability'+id).value))
                }
                else if(id == '3'){
                    stock = stock3 = new Stock("TEST"+id, 'MTR', "Test"+id, Number(document.getElementById('baseValue'+id).value), Number(document.getElementById('stability'+id).value), Number(document.getElementById('grow'+id).value), Number(document.getElementById('volatility'+id).value), Number(document.getElementById('seed'+id).value), Number(document.getElementById('influencability'+id).value), stock2)
                }
                else if(id == '4'){
                    stock = etf = new ETF('ETF' + id, 'OLS', 'etf' + id, [{stock: stock2, perc: 0.5}, {stock: stock3, perc: 0.5}])
                }
                let ctx = document.getElementById(id).querySelector("canvas.chart")
                let days = chartDays1
                let start = ~~GameManager.gameTimer() - chartDays1
                if(id == '2'){
                    start = ~~GameManager.gameTimer() - chartDays2
                    days = chartDays2
                }
                if(id == '3'){
                    start = ~~GameManager.gameTimer() - chartDays3
                    days = chartDays3
                }
                if(id == '4'){
                    start = ~~GameManager.gameTimer() - chartETFdays
                    days = chartETFdays
                }
                stock.simulateHistory(days)
                let end = GameManager.gameTimer()
                let step = (end - start) / PRECISION
                let temp = gm.getHistory(stock.acronym, days)
                let values = [], tempInfluence = [], tempInfluenceValues = []
                //if(id != '1') tempInfluenceValues = stock.influencedBy[0].simulateHistory(days)
                let k = 0
                for (i = start; i < end - 1; i += step){
                    values.push({ x: i * (1000 * 60 * 60 * 24), y: temp[k] })
                    tempInfluence.push({ x: i * (1000 * 60 * 60 * 24), y: tempInfluenceValues[k] })
                    k++
                }
                let datasetsT = [{
                    label: stock.name,
                    indexAxis: 'x',
                    borderWidth: 1,
                    radius: 0,
                    data: values
                }]
                /*if(id != '1'){
                    datasetsT.push({                        //To do: fix bug(on updating time window tempInfluence and values take the same values)
                        label: stock.influencedBy[0].name,
                            indexAxis: 'x',
                            borderWidth: 1,
                            radius: 0,
                            data: tempInfluence
                    })
                }*/
                if(id != '4') document.getElementById('stockValue'+id).innerText = gm.saves[1].stocks[stock.acronym].value.toFixed(2) + " Kr"
                else{
                    document.getElementById('ETF').innerText = gm.saves[1].stocks[stock.acronym].value.toFixed(2) + " Kr"
                    document.getElementById('ETFstock2').innerText = stock.influencedBy[0].perc
                    document.getElementById('ETFstock3').innerText = stock.influencedBy[1].perc
                }
                if (!ctx.chartjs) {
                    let chart = new Chart(ctx, {
                        type: "line",
                        data: {
                            datasets: datasetsT
                        },
                        options: {
                            animation: false,
                            parsing: false,
                            //responsive:false,
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            },
                            plugins: {
                                decimation: {
                                    enabled: true,
                                    samples: 10
                                },
                                legend: {
                                    display: false,
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Data',
                                    },
                                },
                                y: {
                                    type: 'linear',
                                    title: {
                                        display: true,
                                        text: 'Kr',
                                    },
                                    /*min:0*/
                                }
                            },
                        }
                    })
                    ctx.chartjs = chart
                } else {
                    ctx.chartjs.data.datasets = datasetsT
                    ctx.chartjs.update()
                }
            }
            function initChartTest() {
                chartDays1 = 1
                chartDays2 = 1
                chartDays3 = 1
                chartETFdays = 1
                document.getElementById('baseValue1').value = masterStock._baseValue
                document.getElementById('stability1').value = masterStock.stability
                document.getElementById('grow1').value = masterStock.growth
                document.getElementById('volatility1').value = masterStock.volatility
                document.getElementById('seed1').value = masterStock.seed
                id = 2
                stock2 = new Stock("TEST"+id, "t", "Test"+id, Number(document.getElementById('baseValue'+id).value), Number(document.getElementById('stability'+id).value), Number(document.getElementById('grow'+id).value), Number(document.getElementById('volatility'+id).value), Number(document.getElementById('seed'+id).value), Number(document.getElementById('influencability'+id).value))
                id = 3
                stock3 = new Stock("TEST"+id, "t", "Test"+id, Number(document.getElementById('baseValue'+id).value), Number(document.getElementById('stability'+id).value), Number(document.getElementById('grow'+id).value), Number(document.getElementById('volatility'+id).value), Number(document.getElementById('seed'+id).value), Number(document.getElementById('influencability'+id).value), stock2)
                id = 4
                etf = new ETF('ETF' + id, "e", 'etf' + id, [{s: stock2, perc: 0.5}, {s: stock3, perc: 0.5}])
                chartTest_update('1')
                chartTest_update('2')
                chartTest_update('3')
                chartTest_update('4')
            }
        </script>
    </head>

    <body>
        <div>
            Current date: <span id="gameT"></span>
        </div>
        <button style="position: fixed; top: 0; left: auto; right: 0;" onclick="initChartTest()">Initialize stocks</button>
        <div class="temp">
            <div id="1">
                <h2>Master stock</h2>
                <div>
                    Price: <span id="stockValue1"></span>
                </div>
                <div style="width:100%; max-width:50rem; height:30rem;">
                    <canvas class="chart" id="chart1"></canvas>
                </div>
                <div>
                    <button onclick="chartDays1=1;chartTest_update('1')">1d</button>
                    <button onclick="chartDays1=7;chartTest_update('1')">1w</button>
                    <button onclick="chartDays1=30;chartTest_update('1')">1m</button>
                    <button onclick="chartDays1=365;chartTest_update('1')">1y</button>
                    <button onclick="chartDays1=3650;chartTest_update('1')">10y</button>
                    <button onclick="chartDays1=7300;chartTest_update('1')">20y</button>
                    <button onclick="chartDays1=18250;chartTest_update('1')">50y</button>
                    <button onclick="chartDays1=36500;chartTest_update('1')">100y</button>
                </div>
                <table>
                    <tr>
                        <td><label for="baseValue">Base Value</label></td>
                        <td><input type="number" step="1" value="20" id="baseValue1"></td>
                    </tr>
                    <tr>
                        <td><label for="influencabilty">Influencability</label></td>
                        <td><input type="number" step="0.01" value="0" id="influencability1"></td>
                    </tr>
                    <tr>
                        <td><label for="stability">Stability</label></td>
                        <td><input type="number" step="0.1" value="0.5" id="stability1"></td>
                    </tr>
                    <tr>
                        <td><label for="grow">Grow</label></td>
                        <td><input type="number" step="0.1" value="0.7" id="grow1"></td>
                    </tr>
                    <tr>
                        <td><label for="volatility">Volatility</label></td>
                        <td><input type="number" step="0.01" value="0.2" id="volatility1"></td>
                    </tr>
                    <tr>
                        <td><label for="seed">Seed</label></td>
                        <td><input type="number" step="1" value="268953" id="seed1"></td>
                    </tr>
                </table>
            </div>
            <div id="2">
                <h2>Stock 2</h2>
                <div>
                    Price: <span id="stockValue2"></span>
                </div>
                <div style="width:100%; max-width:50rem; height:30rem;">
                    <canvas class="chart" id="chart2"></canvas>
                </div>
                <div>
                    <button onclick="chartDays2=1;chartTest_update('2')">1d</button>
                    <button onclick="chartDays2=7;chartTest_update('2')">1w</button>
                    <button onclick="chartDays2=30;chartTest_update('2')">1m</button>
                    <button onclick="chartDays2=365;chartTest_update('2')">1y</button>
                    <button onclick="chartDays2=3650;chartTest_update('2')">10y</button>
                    <button onclick="chartDays2=7300;chartTest_update('2')">20y</button>
                    <button onclick="chartDays2=18250;chartTest_update('2')">50y</button>
                    <button onclick="chartDays2=36500;chartTest_update('2')">100y</button>
                </div>
                <table>
                    <tr>
                        <td><label for="baseValue">Base Value</label></td>
                        <td><input type="number" step="1" value="100" id="baseValue2"></td>
                    </tr>
                    <tr>
                        <td><label for="influencabilty">Influencability</label></td>
                        <td><input type="number" step="0.0001" value="0.0005" id="influencability2"></td>
                    </tr>
                    <tr>
                        <td><label for="stability">Stability</label></td>
                        <td><input type="number" step="0.1" value="0.2" id="stability2"></td>
                    </tr>
                    <tr>
                        <td><label for="grow">Grow</label></td>
                        <td><input type="number" step="0.1" value="0.1" id="grow2"></td>
                    </tr>
                    <tr>
                        <td><label for="volatility">Volatility</label></td>
                        <td><input type="number" step="0.01" value="0.8" id="volatility2"></td>
                    </tr>
                    <tr>
                        <td><label for="seed">Seed</label></td>
                        <td><input type="number" step="1" value="647852" id="seed2"></td>
                    </tr>
                </table>
            </div>
            <div id="3">
                <h2>Stock 3</h2>
                <div>
                    Price: <span id="stockValue3"></span>
                </div>
                <div style="width:100%; max-width:50rem; height:30rem;">
                    <canvas class="chart" id="chart3"></canvas>
                </div>
                <div>
                    <button onclick="chartDays3=1;chartTest_update('3')">1d</button>
                    <button onclick="chartDays3=7;chartTest_update('3')">1w</button>
                    <button onclick="chartDays3=30;chartTest_update('3')">1m</button>
                    <button onclick="chartDays3=365;chartTest_update('3')">1y</button>
                    <button onclick="chartDays3=3650;chartTest_update('3')">10y</button>
                    <button onclick="chartDays3=7300;chartTest_update('3')">20y</button>
                    <button onclick="chartDays3=18250;chartTest_update('3')">50y</button>
                    <button onclick="chartDays3=36500;chartTest_update('3')">100y</button>
                </div>
                <table>
                    <tr>
                        <td><label for="baseValue">Base Value</label></td>
                        <td><input type="number" step="1" value="50" id="baseValue3"></td>
                    </tr>
                    <tr>
                        <td><label for="influencabilty">Influencability</label></td>
                        <td><input type="number" step="0.01" value="0.7" id="influencability3"></td>
                    </tr>
                    <tr>
                        <td><label for="stability">Stability</label></td>
                        <td><input type="number" step="0.1" value="0.8" id="stability3"></td>
                    </tr>
                    <tr>
                        <td><label for="grow">Grow</label></td>
                        <td><input type="number" step="0.1" value="0.2" id="grow3"></td>
                    </tr>
                    <tr>
                        <td><label for="volatility">Volatility</label></td>
                        <td><input type="number" step="0.01" value="0.2" id="volatility3"></td>
                    </tr>
                    <tr>
                        <td><label for="seed">Seed</label></td>
                        <td><input type="number" step="1" value="999999" id="seed3"></td>
                    </tr>
                </table>
            </div>
            <div id="4">
                <h2>ETF</h2>
                <div>
                    Price: <span id="ETF"></span>
                </div>
                <div style="width:100%; max-width:50rem; height:30rem;">
                    <canvas class="chart" id="etf"></canvas>
                </div>
                <div>
                    <button onclick="chartETFdays=1;chartTest_update('4')">1d</button>
                    <button onclick="chartETFdays=7;chartTest_update('4')">1w</button>
                    <button onclick="chartETFdays=30;chartTest_update('4')">1m</button>
                    <button onclick="chartETFdays=365;chartTest_update('4')">1y</button>
                    <button onclick="chartETFdays=3650;chartTest_update('4')">10y</button>
                    <button onclick="chartETFdays=7300;chartTest_update('4')">20y</button>
                    <button onclick="chartETFdays=18250;chartTest_update('4')">50y</button>
                    <button onclick="chartETFdays=36500;chartTest_update('4')">100y</button>
                </div>
                <table>
                    <tr style="background:rgba(255,255,255,0.5); margin-left: 5rem;">
                        <td>Stock 2</td>
                        <td id="ETFstock2"></td>
                    </tr>
                    <tr style="background:rgba(255,255,255,0.5); margin-left: 5rem;">
                        <td>Stock 3</td>
                        <td id="ETFstock3"></td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>